var CreateSequelize, RunTest, StartApp, app;

StartApp = require('../actions/StartApp');

CreateSequelize = require('../actions/CreateSequelize');

RunTest = require('../actions/RunTest');

app = angular.module("WEBYI", ["ngSanitize", "ui.router", "ngMessages"]).config(function($locationProvider, $urlRouterProvider) {
  return $urlRouterProvider.otherwise("/site/index");
}).run(function($rootScope, $state, CoAuth, WindowInfo) {
  $rootScope.$state = $state;
  $rootScope.CoAuth = CoAuth;
  return $rootScope.WindowInfo = WindowInfo;
});

app.controller('SchemaFormCtrl', function($scope, SchemaModel, $state) {
  $scope.schema = new SchemaModel();
  $scope.field_types = SchemaModel.field_types;
  $scope.schemas = [];
  $scope.addField = function() {
    $scope.schema.addField();
    return console.log($scope.schema, $scope.schema.get('fields'));
  };
  $scope.delField = function(index) {
    return $scope.schema.fields.splice(index, 1);
  };
  $scope.addEnum = function(field) {
    return field.enums.push({
      value: ''
    });
  };
  $scope.delEnum = function(field, index) {
    return field.enums.splice(index, 1);
  };
  return $scope.save = function() {
    return SchemaModel.save($scope.schema).then(function(res) {
      $state.go('schema.update', {
        _id: res._id
      });
      return res;
    }).then(function(doc) {
      return socket.emit('RunSchameTest', doc);
    }).fail(function(err) {
      return console.log(err);
    }).done();
  };
});

app.controller('SiteIndexCtrl', function($scope, $element, WindowInfo) {
  var project_path;
  project_path = 'E:/htdocs/Co-sumaitong/src/trunk5/';
  $scope.joinAppAndStart = function() {
    return StartApp.run(project_path, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.createSchemas = function() {
    return CreateSequelize.createSchemas(project_path, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.createModels = function() {
    return CreateSequelize.createModels(project_path, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.createRouters = function() {
    return CreateSequelize.createRouters(project_path, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.createModelTests = function() {
    return CreateSequelize.createModelTests(project_path, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.runTest = function(params) {
    return RunTest.run(project_path, params, function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.stopAllTest = function() {
    return RunTest.closeAll(function(data) {
      return $scope.$broadcast('console:message', data);
    });
  };
  $scope.running_list = _.keys(StartApp.services);
  return RunTest.getTestTree(project_path).then(function(res) {
    return $scope.$apply(function() {
      return $scope.test_list = res;
    });
  });
});


/*
控制台面板
<div console-panel name="message"></div>
示例：$scope.$broadcast 'console:message', '11111111111'
 */
app.directive('consolePanel', function(FormatJsonView) {
  return {
    restrict: "AE",
    replace: true,
    template: '<div></div>',
    scope: true,
    link: function(scope, element, attrs, ctrl) {
      var addData, name, row_number;
      $(element).css({
        height: '100%',
        overflow: 'auto',
        background: '#101010',
        float: 'left',
        width: '55%'
      });
      row_number = 0;
      addData = function(data) {
        var log, pre;
        if (typeof data === "object") {
          data = FormatJsonView(data);
        } else {
          if (typeof data === "string") {
            data = ansi2html($('<div/>').text(data).html());
          }
        }
        log = void 0;
        row_number++;
        if ($(element).find(".log-line").length < 200) {
          log = $(document.createElement("div")).addClass("log-line").css({
            position: "relative"
          });
        } else {
          log = $(element).find(".log-line:first").html("");
        }
        log.appendTo(element);
        pre = $("<pre></pre>").css({
          paddingLeft: 55,
          fontSize: 14
        }).html(data).appendTo(log);
        $("<p>" + row_number + "</p>").css({
          position: "absolute",
          margin: 0,
          textAlign: "right",
          paddingRight: 5,
          left: 0,
          width: 50,
          top: 0,
          bottom: 0,
          background: "#292929"
        }).prependTo(log);
        return $(element).scrollTop($(element)[0].scrollHeight);
      };
      name = attrs.name || 'console';
      return scope.$on('console:' + name, function(event, data) {
        return addData(data);
      });
    }
  };
});

app.directive("onCtrlS", function() {
  return {
    priority: 100,
    restrict: "AE",
    scope: {
      onCtrlS: "&"
    },
    link: function(scope, element, attrs) {
      $(element).bind('keydown', function(e) {
        if (e.ctrlKey && e.keyCode === 83) {
          scope.$apply(function() {
            return scope.onCtrlS();
          });
          return e.preventDefault();
        }
      });
      return scope.$on('$destroy', function() {
        return $(element).unbind('keydown');
      });
    }
  };
});

app.config(function($stateProvider, $urlRouterProvider) {
  return $stateProvider.state("schema", {
    url: "/schema",
    views: {
      container: {
        templateUrl: "templates/schemas/layout.html"
      }
    }
  }).state("schema.index", {
    url: "/index",
    views: {
      container: {
        templateUrl: "templates/schemas/schema-form.html"
      }
    }
  });
});

app.config(function($stateProvider, $urlRouterProvider) {
  return $stateProvider.state("site", {
    url: "/site",
    views: {
      container: {
        templateUrl: "templates/site/layout.html"
      }
    }
  }).state("site.index", {
    url: "/index",
    views: {
      container: {
        templateUrl: "templates/site/index.html"
      }
    }
  });
});

app.factory('CoAuth', function() {
  return this;
});


/*
JSON格式化与缩进显示
 */
app.factory('FormatJsonView', function() {
  var formatJson;
  return formatJson = function(json, options) {
    var PADDING, formatted, pad, reg;
    reg = null;
    formatted = "";
    pad = 0;
    PADDING = "    ";
    options = options || {};
    options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true ? true : false);
    options.spaceAfterColon = (options.spaceAfterColon === false ? false : true);
    if (typeof json !== "string") {
      json = JSON.stringify(json);
    } else {
      json = JSON.parse(json);
      json = JSON.stringify(json);
    }
    reg = /([\{\}])/g;
    json = json.replace(reg, "\r\n$1\r\n");
    reg = /([\[\]])/g;
    json = json.replace(reg, "\r\n$1\r\n");
    reg = /(\,)/g;
    json = json.replace(reg, "$1\r\n");
    reg = /(\r\n\r\n)/g;
    json = json.replace(reg, "\r\n");
    reg = /\r\n\,/g;
    json = json.replace(reg, ",");
    if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
      reg = /\:\r\n\{/g;
      json = json.replace(reg, ":{");
      reg = /\:\r\n\[/g;
      json = json.replace(reg, ":[");
    }
    if (options.spaceAfterColon) {
      reg = /\:/g;
      json = json.replace(reg, ": ");
    }
    $.each(json.split("\r\n"), function(index, node) {
      var i, indent, padding;
      i = 0;
      indent = 0;
      padding = "";
      if (node.match(/\{$/) || node.match(/\[$/)) {
        indent = 1;
      } else if (node.match(/\}/) || node.match(/\]/)) {
        if (pad !== 0) {
          pad -= 1;
        }
      } else {
        indent = 0;
      }
      i = 0;
      while (i < pad) {
        padding += PADDING;
        i++;
      }
      formatted += padding + node + "\r\n";
      return pad += indent;
    });
    return formatted;
  };
});

app.factory('SocketConnect', function() {
  var _handlers, socket;
  _handlers = {};
  socket = $(document);
  socket.emit = function(event_name, data) {
    console.log(event_name, data);
    return socket.trigger(event_name, data);
  };
  socket.on("error", function(err) {
    return console.log("err", err, err.stack);
  });
  socket.on("console", function(data) {
    return console.log(data);
  });
  return socket;
});

app.factory('WindowInfo', function($rootScope) {
  var ths;
  ths = this;
  ths.height = $(window).height();
  ths.width = $(window).width();
  $(window).resize(function() {
    return $rootScope.$apply(function() {
      ths.height = $(this).height();
      return ths.width = $(this).width();
    });
  });
  return ths;
});

//# sourceMappingURL=app.min.js.map